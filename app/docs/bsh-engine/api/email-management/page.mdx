---
title: Email Management API
---

# Email Management API

The Email Management API provides endpoints for sending emails, managing email templates, and tracking email delivery status.

## Base Endpoint

```
{{baseUrl}}/api/mailing
```

## Endpoints

### Send Email

Send an email using either plain text, HTML content, or email templates.

**Endpoint:** `POST /api/mailing/send`

**Headers:**
```
Authorization: Bearer {{accessToken}}
Content-Type: application/json
```

#### Send Plain Text Email

**Request Body:**
```json
{
  "to": "recipient@example.com",
  "subject": "Test Email",
  "body": "This is a test email body",
  "html": false
}
```

#### Send HTML Email

**Request Body:**
```json
{
  "to": "recipient@example.com",
  "subject": "HTML Test Email",
  "body": "<h1>Hello World</h1><p>This is an <strong>HTML</strong> email.</p>",
  "html": true
}
```

#### Send Template Email

**Request Body:**
```json
{
  "to": "recipient@example.com",
  "template": "TestTemplate",
  "data": {
    "name": "User",
    "domain": "http://localhost:7200/dashboard/email/templates"
  }
}
```

**Response:**
```json
{
  "success": true,
  "data": {
    "emailId": "email-123",
    "to": "recipient@example.com",
    "subject": "Test Email",
    "status": "sent",
    "sentAt": "2024-01-15T10:30:00Z",
    "messageId": "msg-abc123"
  }
}
```

## Email Templates

### Template System

The email system supports dynamic templates with variable substitution:

#### Template Structure

Templates are stored in the system and can be referenced by name:

```json
{
  "template": "welcome-email",
  "data": {
    "userName": "John Doe",
    "loginUrl": "https://app.example.com/login",
    "supportEmail": "support@example.com"
  }
}
```

#### Common Templates

| Template Name | Purpose | Required Data |
|---------------|---------|---------------|
| `welcome-email` | User welcome message | `userName`, `loginUrl` |
| `password-reset` | Password reset instructions | `userName`, `resetUrl` |
| `account-activation` | Account activation | `userName`, `activationUrl` |
| `notification` | General notifications | `title`, `message`, `actionUrl` |

#### Template Variables

Templates support the following variable types:

- **String variables:** `{{userName}}`, `{{email}}`
- **URL variables:** `{{loginUrl}}`, `{{resetUrl}}`
- **Conditional blocks:** `{{#if isActive}}...{{/if}}`
- **Loops:** `{{#each items}}...{{/each}}`

### Creating Templates

Templates can be created through the admin interface or API:

```json
{
  "name": "welcome-email",
  "subject": "Welcome to {{appName}}, {{userName}}!",
  "body": `
    <h1>Welcome {{userName}}!</h1>
    <p>Thank you for joining {{appName}}.</p>
    <p>You can now access your account at: <a href="{{loginUrl}}">Login</a></p>
    <p>If you have any questions, contact us at {{supportEmail}}.</p>
  `,
  "variables": ["userName", "appName", "loginUrl", "supportEmail"]
}
```

## Email Configuration

### SMTP Configuration

Email sending is configured through the BshConfigurations entity:

```json
{
  "name": "email-settings(gmail)",
  "config": {
    "email": "admin@example.com",
    "password": "app_password",
    "host": "smtp.gmail.com",
    "port": 587,
    "protocol": "smtp",
    "auth": true,
    "starttls": true,
    "from": "admin@example.com"
  }
}
```

### Supported Email Providers

| Provider | Host | Port | Security |
|----------|------|------|----------|
| Gmail | smtp.gmail.com | 587 | STARTTLS |
| Outlook | smtp-mail.outlook.com | 587 | STARTTLS |
| Yahoo | smtp.mail.yahoo.com | 587 | STARTTLS |
| SendGrid | smtp.sendgrid.net | 587 | STARTTLS |
| Mailgun | smtp.mailgun.org | 587 | STARTTLS |

### Configuration Examples

#### Gmail Configuration
```json
{
  "name": "email-settings(gmail)",
  "config": {
    "email": "your-email@gmail.com",
    "password": "your-app-password",
    "host": "smtp.gmail.com",
    "port": 587,
    "protocol": "smtp",
    "auth": true,
    "starttls": true,
    "from": "your-email@gmail.com"
  }
}
```

#### SendGrid Configuration
```json
{
  "name": "email-settings(sendgrid)",
  "config": {
    "email": "apikey",
    "password": "your-sendgrid-api-key",
    "host": "smtp.sendgrid.net",
    "port": 587,
    "protocol": "smtp",
    "auth": true,
    "starttls": true,
    "from": "noreply@yourdomain.com"
  }
}
```

## Email Tracking

### Email Logs

All sent emails are logged in the BshEmails entity for tracking and auditing:

#### Search Email Logs

**Endpoint:** `POST /api/entities/BshEmails/search`

**Request Body:**
```json
{
  "fields": ["Id", "to", "subject", "sentAt", "status"],
  "query": [
    {
      "field": "to",
      "operator": "eq",
      "value": "user@example.com",
      "type": "string"
    },
    {
      "field": "sentAt",
      "operator": "gte",
      "value": "2024-01-01T00:00:00Z",
      "type": "datetime"
    }
  ],
  "sort": [
    {
      "field": "sentAt",
      "direction": -1
    }
  ],
  "pagination": {
    "page": 0,
    "size": 20
  }
}
```

#### Email Status Tracking

Email status is tracked through the following states:

| Status | Description |
|--------|-------------|
| `pending` | Email queued for sending |
| `sent` | Email successfully sent |
| `delivered` | Email delivered to recipient |
| `opened` | Email opened by recipient |
| `clicked` | Link in email clicked |
| `bounced` | Email bounced back |
| `failed` | Email sending failed |

### Delivery Reports

Get delivery statistics:

```javascript
// Get email delivery stats
const statsRequest = {
  fields: ["status", "sentAt"],
  query: [
    {
      field: "sentAt",
      operator: "gte",
      value: "2024-01-01T00:00:00Z",
      type: "datetime"
    }
  ]
};

const response = await fetch('/api/entities/BshEmails/search', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${accessToken}`,
    'Content-Type': 'application/json'
  },
  body: JSON.stringify(statsRequest)
});
```

## Advanced Features

### Bulk Email Sending

Send emails to multiple recipients:

```javascript
const recipients = [
  "user1@example.com",
  "user2@example.com",
  "user3@example.com"
];

const emailPromises = recipients.map(email => 
  fetch('/api/mailing/send', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${accessToken}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      to: email,
      template: "newsletter",
      data: {
        userName: "User",
        unsubscribeUrl: `https://app.example.com/unsubscribe?email=${email}`
      }
    })
  })
);

const results = await Promise.all(emailPromises);
```

### Email Scheduling

Schedule emails for future delivery:

```javascript
const scheduledEmail = {
  to: "user@example.com",
  template: "reminder",
  data: {
    userName: "John",
    reminderText: "Don't forget your appointment tomorrow"
  },
  scheduledAt: "2024-01-16T09:00:00Z"
};

// Note: Scheduling requires additional implementation
```

### Email Attachments

Send emails with attachments:

```javascript
const formData = new FormData();
formData.append('to', 'user@example.com');
formData.append('subject', 'Document Attached');
formData.append('body', 'Please find the attached document.');
formData.append('attachment', fileInput.files[0]);

fetch('/api/mailing/send', {
  method: 'POST',
  headers: {
    'Authorization': `Bearer ${accessToken}`
  },
  body: formData
});
```

## Error Handling

### Common Error Responses

#### Invalid Email Address
```json
{
  "success": false,
  "error": {
    "code": "INVALID_EMAIL",
    "message": "Invalid email address format",
    "details": {
      "email": "invalid-email"
    }
  }
}
```

#### Template Not Found
```json
{
  "success": false,
  "error": {
    "code": "TEMPLATE_NOT_FOUND",
    "message": "Email template not found",
    "details": {
      "template": "nonexistent-template"
    }
  }
}
```

#### SMTP Configuration Error
```json
{
  "success": false,
  "error": {
    "code": "SMTP_ERROR",
    "message": "Failed to send email",
    "details": {
      "reason": "Authentication failed",
      "host": "smtp.gmail.com"
    }
  }
}
```

#### Rate Limit Exceeded
```json
{
  "success": false,
  "error": {
    "code": "RATE_LIMIT_EXCEEDED",
    "message": "Email sending rate limit exceeded",
    "details": {
      "limit": "100 emails per hour",
      "retryAfter": "2024-01-15T11:30:00Z"
    }
  }
}
```

## Security and Compliance

### Email Security

- **Authentication:** All email endpoints require authentication
- **Rate limiting:** Prevents email spam and abuse
- **Content validation:** Email content is validated before sending
- **Attachment scanning:** Attachments are scanned for malware

### Compliance

- **CAN-SPAM Act:** Emails include proper unsubscribe links
- **GDPR:** Email handling complies with data protection regulations
- **Audit trail:** All email activities are logged for compliance
- **Data retention:** Email logs are retained according to policy

### Best Practices

1. **Use templates:** Create reusable email templates
2. **Validate recipients:** Always validate email addresses
3. **Include unsubscribe:** Provide unsubscribe links in marketing emails
4. **Monitor delivery:** Track email delivery and engagement
5. **Handle bounces:** Implement bounce handling for invalid addresses

## Rate Limiting

Email sending is subject to rate limiting:

- **Individual users:** 100 emails per hour
- **Bulk sending:** 1000 emails per hour
- **Template emails:** 500 emails per hour
- **Attachment emails:** 50 emails per hour

Check response headers for current limits:
- `X-RateLimit-Limit`
- `X-RateLimit-Remaining`
- `X-RateLimit-Reset`

## Example Implementation

```javascript
class EmailService {
  constructor(apiBaseUrl, accessToken) {
    this.apiBaseUrl = apiBaseUrl;
    this.accessToken = accessToken;
  }

  async sendEmail(emailData) {
    try {
      const response = await fetch(`${this.apiBaseUrl}/api/mailing/send`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${this.accessToken}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(emailData)
      });

      const result = await response.json();
      
      if (!result.success) {
        throw new Error(result.error.message);
      }

      return result.data;
    } catch (error) {
      console.error('Email sending failed:', error);
      throw error;
    }
  }

  async sendTemplateEmail(to, template, data) {
    return this.sendEmail({
      to,
      template,
      data
    });
  }

  async sendBulkEmails(recipients, template, data) {
    const emailPromises = recipients.map(email => 
      this.sendTemplateEmail(email, template, data)
    );
    
    return Promise.all(emailPromises);
  }

  async getEmailLogs(filters = {}) {
    const searchRequest = {
      fields: ["Id", "to", "subject", "sentAt", "status"],
      query: [],
      sort: [{ field: "sentAt", direction: -1 }],
      pagination: { page: 0, size: 20 }
    };

    // Add filters
    if (filters.recipient) {
      searchRequest.query.push({
        field: "to",
        operator: "eq",
        value: filters.recipient,
        type: "string"
      });
    }

    if (filters.dateFrom) {
      searchRequest.query.push({
        field: "sentAt",
        operator: "gte",
        value: filters.dateFrom,
        type: "datetime"
      });
    }

    const response = await fetch(`${this.apiBaseUrl}/api/entities/BshEmails/search`, {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${this.accessToken}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(searchRequest)
    });

    const result = await response.json();
    return result.data;
  }
}

// Usage
const emailService = new EmailService('http://localhost:7071', accessToken);

// Send template email
await emailService.sendTemplateEmail(
  'user@example.com',
  'welcome-email',
  {
    userName: 'John Doe',
    loginUrl: 'https://app.example.com/login',
    supportEmail: 'support@example.com'
  }
);

// Send bulk emails
const recipients = ['user1@example.com', 'user2@example.com'];
await emailService.sendBulkEmails(
  recipients,
  'newsletter',
  {
    userName: 'User',
    newsletterContent: 'Latest updates...'
  }
);

// Get email logs
const logs = await emailService.getEmailLogs({
  recipient: 'user@example.com',
  dateFrom: '2024-01-01T00:00:00Z'
});
```
